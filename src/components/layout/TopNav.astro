---
import { tracks } from '../../lib/tracks';
import ThemeSwitcher from '../react/ThemeSwitcher';
import Icon from '../ui/Icon.astro';

interface Props {
  activeTrack?: string;
}

const { activeTrack } = Astro.props;
---

<nav
  class="fixed top-0 right-0 left-0 z-50 h-14 border-b border-[var(--color-border)] bg-[var(--color-bg)]/80 backdrop-blur-xl"
>
  <div class="mx-auto flex h-full max-w-7xl items-center justify-between px-4 sm:px-6">
    <a href="/" class="flex items-center gap-2 text-sm font-bold tracking-tight transition-opacity hover:opacity-80">
      <Icon name="coffee-code" size={16} />
      <span>Brewnary</span>
    </a>

    <div class="hidden items-center gap-1 md:flex">
      <div class="relative" id="tracks-dropdown">
        <button
          id="tracks-dropdown-btn"
          class="flex items-center gap-1 rounded-lg px-3 py-1.5 text-sm text-[var(--color-text-muted)] transition-colors hover:text-[var(--color-text)]"
        >
          Tópicos
          <svg
            class="h-3 w-3"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            aria-hidden="true"
          >
            <path d="m6 9 6 6 6-6"></path>
          </svg>
        </button>
        <div
          id="tracks-dropdown-menu"
          class="absolute top-full left-0 mt-1 hidden w-52 overflow-hidden rounded-lg border border-[var(--color-border)] bg-[var(--color-bg-alt)] py-1 shadow-xl"
        >
          {
            tracks.map((track) => (
              <a
                href={`/trilha/${track.id}`}
                class:list={[
                  'flex items-center gap-2.5 px-3 py-2 text-sm transition-colors',
                  activeTrack === track.id
                    ? 'bg-[var(--color-border)]/30 text-[var(--color-text)]'
                    : 'text-[var(--color-text-muted)] hover:bg-[var(--color-border)]/20 hover:text-[var(--color-text)]',
                ]}
              >
                <span class="h-1.5 w-1.5 shrink-0 rounded-full" style={`background-color: ${track.color}`} />
                {track.shortTitle}
              </a>
            ))
          }
        </div>
      </div>

      <a
        href="/livros"
        class="rounded-lg px-3 py-1.5 text-sm text-[var(--color-text-muted)] transition-colors hover:text-[var(--color-text)]"
      >
        Livros
      </a>
      <a
        href="/diagramas"
        class="rounded-lg px-3 py-1.5 text-sm text-[var(--color-text-muted)] transition-colors hover:text-[var(--color-text)]"
      >
        Diagramas
      </a>
    </div>

    <div class="flex items-center gap-2">
      <button
        id="search-btn"
        class="hidden items-center gap-2 rounded-lg border border-[var(--color-border)] px-2.5 py-1 text-xs text-[var(--color-text-muted)] transition-colors hover:border-[var(--color-text-muted)] sm:flex"
      >
        <svg
          class="h-3.5 w-3.5"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          aria-hidden="true"
        >
          <circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"></path>
        </svg>
        <kbd class="font-mono text-[10px]">⌘K</kbd>
      </button>

      <ThemeSwitcher client:load />

      <button
        id="mobile-menu-btn"
        class="rounded-lg p-2 transition-colors hover:bg-[var(--color-border)]/30 md:hidden"
        aria-label="Menu"
      >
        <svg
          class="h-5 w-5"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          aria-hidden="true"
        >
          <line x1="4" x2="20" y1="12" y2="12"></line><line x1="4" x2="20" y1="6" y2="6"></line><line
            x1="4"
            x2="20"
            y1="18"
            y2="18"></line>
        </svg>
      </button>
    </div>
  </div>

  <div
    id="mobile-menu"
    class="hidden border-b border-[var(--color-border)] bg-[var(--color-bg-alt)] shadow-lg md:hidden"
  >
    <div class="space-y-1 px-4 py-3">
      {
        tracks.map((track) => (
          <a
            href={`/trilha/${track.id}`}
            class="flex items-center gap-2 rounded-lg px-3 py-2 text-sm transition-colors hover:bg-[var(--color-border)]/30"
          >
            <span class="h-1.5 w-1.5 rounded-full" style={`background-color: ${track.color}`} />
            {track.shortTitle}
          </a>
        ))
      }
      <hr class="my-2 border-[var(--color-border)]" />
      <a href="/livros" class="block rounded-lg px-3 py-2 text-sm transition-colors hover:bg-[var(--color-border)]/30">
        Livros
      </a>
      <a
        href="/diagramas"
        class="block rounded-lg px-3 py-2 text-sm transition-colors hover:bg-[var(--color-border)]/30"
      >
        Diagramas
      </a>
    </div>
  </div>
</nav>

<script>
  function initNav() {
    const btn = document.getElementById('mobile-menu-btn');
    const menu = document.getElementById('mobile-menu');
    btn?.addEventListener('click', () => menu?.classList.toggle('hidden'));

    const searchBtn = document.getElementById('search-btn');
    searchBtn?.addEventListener('click', () => {
      window.dispatchEvent(new KeyboardEvent('keydown', { key: 'k', metaKey: true }));
    });

    const dropdownBtn = document.getElementById('tracks-dropdown-btn');
    const dropdownMenu = document.getElementById('tracks-dropdown-menu');
    dropdownBtn?.addEventListener('click', () => dropdownMenu?.classList.toggle('hidden'));
    document.addEventListener('click', (e) => {
      const dropdown = document.getElementById('tracks-dropdown');
      if (dropdown && !dropdown.contains(e.target as Node)) {
        dropdownMenu?.classList.add('hidden');
      }
    });

    document.querySelectorAll('#mobile-menu a').forEach((link) => {
      link.addEventListener('click', () => menu?.classList.add('hidden'));
    });
  }

  initNav();
  document.addEventListener('astro:after-swap', initNav);
</script>
